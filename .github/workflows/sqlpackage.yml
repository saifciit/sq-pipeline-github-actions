# name: Deploy SQL Server Scripts

# on:
#   push:
#     branches:
#       - main

# jobs:
#   deploy:
#     runs-on: windows-latest

#     steps:
#     - name: Checkout code
#       uses: actions/checkout@v3

#     - name: Install SQL Server Command Line Tools
#       run: |
#         choco install sqlcmd -y

#     - name: Run SQL Scripts using sqlcmd
#       run: |
#         cmd /c "sqlcmd -S ${{ secrets.SQL_SERVER }} -d ${{ secrets.SQL_DB }} -U ${{ secrets.SQL_USER }} -P ${{ secrets.SQL_PASSWORD }} -i scripts/create_tables.sql"
#         cmd /c "sqlcmd -S ${{ secrets.SQL_SERVER }} -d ${{ secrets.SQL_DB }} -U ${{ secrets.SQL_USER }} -P ${{ secrets.SQL_PASSWORD }} -i scripts/create_views.sql"
#         cmd /c "sqlcmd -S ${{ secrets.SQL_SERVER }} -d ${{ secrets.SQL_DB }} -U ${{ secrets.SQL_USER }} -P ${{ secrets.SQL_PASSWORD }} -i scripts/create_procedures.sql"


name: Build & Deploy SQL Server Project

on:
  push:
    branches: [main]

jobs:
  deploy-sql:
    runs-on: windows-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.3.1

    - name: Build SQL Project (.sqlproj)
      run: |
        msbuild SqlPipeline.sqlproj /p:Configuration=Release

    - name: Download SqlPackage
      run: |
        Invoke-WebRequest -Uri "https://aka.ms/sqlpackage-win-x64" -OutFile "sqlpackage.zip"
        Expand-Archive -Path "sqlpackage.zip" -DestinationPath "sqlpackage"
      shell: pwsh

    - name: Generate deploy.sql from DACPAC
      run: |
        ./sqlpackage/sqlpackage.exe /Action:Script `
          /SourceFile:"bin\Release\SqlPipeline.dacpac" `
          /TargetDatabaseName:"${{ secrets.SQL_DATABASE }}" `
          /OutputPath:"deploy.sql"
      shell: pwsh

    - name: Generate deploy.sql from DACPAC
      run: |
        "C:\Program Files\Microsoft SQL Server\160\DAC\bin\SqlPackage.exe" `
          /Action:Script `
          /SourceFile:"SqlPipeline\bin\Release\SqlPipeline.dacpac" `
          /TargetDatabaseName:${{ secrets.SQL_DATABASE }} `
          /OutputPath:"deploy.sql"
      shell: powershell

    - name: Run deploy.sql using sqlcmd
      run: |
        sqlcmd -S "${{ secrets.SQL_SERVER }}" `
               -d "${{ secrets.SQL_DB }}" `
               -U "${{ secrets.SQL_USER }}" `
               -P "${{ secrets.SQL_PASSWORD }}" `
               -i "deploy.sql"


# name: Deploy SQL Server Scripts

# on:
#   push:
#     branches:
#       - main

# jobs:
#   deploy:
#     runs-on: windows-latest

#     steps:
#     - name: Checkout code
#       uses: actions/checkout@v3

#     - name: Install SQL Server Command Line Tools
#       run: |
#         choco install sqlcmd -y

#     - name: Run SQL Scripts using sqlcmd
#       run: |
#         cmd /c "sqlcmd -S ${{ secrets.SQL_SERVER }} -d ${{ secrets.SQL_DB }} -U ${{ secrets.SQL_USER }} -P ${{ secrets.SQL_PASSWORD }} -i scripts/create_tables.sql"
#         cmd /c "sqlcmd -S ${{ secrets.SQL_SERVER }} -d ${{ secrets.SQL_DB }} -U ${{ secrets.SQL_USER }} -P ${{ secrets.SQL_PASSWORD }} -i scripts/create_views.sql"
#         cmd /c "sqlcmd -S ${{ secrets.SQL_SERVER }} -d ${{ secrets.SQL_DB }} -U ${{ secrets.SQL_USER }} -P ${{ secrets.SQL_PASSWORD }} -i scripts/create_procedures.sql"
